name: Update Xray install script

on:
  workflow_dispatch: {}
  schedule:
    # 每天凌晨0点检查一次
    - cron: "0 0 * * *"

permissions:
  contents: write

jobs:
  update-xray-install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch upstream script
        run: |
          set -euo pipefail
          curl -fsSL "https://github.com/XTLS/Xray-install/raw/refs/heads/main/install-release.sh" \
            -o /tmp/install-release.upstream.sh

      - name: Transform script (path rewrites + mkdir injection)
        id: transform
        shell: bash
        run: |
          set -euo pipefail
          SRC="/tmp/install-release.upstream.sh"
          TMP="/tmp/install-release.transformed.sh"

          # 路径替换
          sed -e 's#/usr/local/share/xray#/home/xray/dat#g' \
              -e 's#/usr/local/etc/xray#/home/xray#g' \
              -e 's#/usr/local/bin/#/home/xray/#g' \
              -e 's#/var/log/xray/#/home/xray/log/#g' \
              "$SRC" \
          | awk '1; /# Gobal verbals/ {print "mkdir -p /home/xray/{log,dat}"}' \
          > "$TMP"

          chmod +x "$TMP"
          # 统一行尾为 LF
          sed -i 's/\r$//' "$TMP"

          # 目标文件保存在仓库根目录；如需放到别处可改这个变量
          TARGET="install-release.sh"

          if [ ! -f "$TARGET" ]; then
            echo "No existing $TARGET in repo; creating it."
            mv "$TMP" "$TARGET"
            UPDATED=1
          else
            if ! diff -q "$TMP" "$TARGET" >/dev/null 2>&1; then
              mv "$TMP" "$TARGET"
              UPDATED=1
            else
              UPDATED=0
            fi
          fi

          echo "updated=$UPDATED" >> "$GITHUB_OUTPUT"

      - name: Commit & push if changed
        if: steps.transform.outputs.updated == '1'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add install-release.sh
          git commit -m "chore: sync Xray install-release.sh from upstream and apply path rewrites"
          git push
